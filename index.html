<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coachgit - App</title>

    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <script src="https://cdn.botpress.cloud/webchat/v3.5/inject.js"></script>

    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        #login-container {
            text-align: center;
            /* DEFAULT HIDDEN to prevent flicker. We show it only if needed. */
            display: none; 
        }

        #login-btn {
            padding: 12px 24px;
            background-color: #00a2c7;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
        }

        #logout-btn {
            display: none;
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background: #ff4b2b;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        #bp-embedded-webchat {
            width: 100%;
            max-width: 450px;
            /* Changed to 85vh for taller window */
            height: 85vh;
            background-color: #1e1e1e;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            border: 1px solid #333;
            display: none;
        }

        h1 {
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .highlight {
            color: #00a2c7;
        }
    </style>
</head>

<body>

    <button id="logout-btn">Log Out</button>

    <div id="login-container">
        <h1>Coach<span class="highlight">git</span></h1>
        <p>Please sign in to access your coach.</p>
        <button id="login-btn">Log In</button>
    </div>

    <div id="bp-embedded-webchat"></div>

<script>
    let auth0Client = null;

    const initializeAuth = async () => {
        const isRedirecting = window.location.search.includes("code=");

        if (!window.auth0) {
            setTimeout(initializeAuth, 500);
            return;
        }

        try {
            auth0Client = await window.auth0.createAuth0Client({
                domain: "dev-tw75vmgwx8fsds2q.us.auth0.com",
                clientId: "ns2usKminMksO2QX06wQYnupz1ttbHqH",
                authorizationParams: {
                    redirect_uri: "https://www.coachgit.com/index.html"
                }
            });

            if (isRedirecting) {
                await auth0Client.handleRedirectCallback();
                window.history.replaceState({}, document.title, "/index.html");
            }

            const isAuthenticated = await auth0Client.isAuthenticated();

            if (isAuthenticated) {
                const user = await auth0Client.getUser();
                loadBotpress(user);
            } else {
                document.getElementById('login-container').style.display = 'block';
                document.getElementById('login-btn').onclick = async () => {
                    await auth0Client.loginWithRedirect();
                };
            }
        } catch (err) {
            console.error("Auth0 error:", err);
            document.getElementById('login-container').style.display = 'block';
        }
    };

    const loadBotpress = async (user) => {
        let userData = null;
        try {
            // Added the key directly to bypass the 401 error
            const funcKey = "0WPTUN0nlsiViGCXRAYJ4NPiXVVGcTlclBZo4m44B9-BAzFu_AAPWg==";
            const response = await fetch(`/api/getCoachProfile?email=${user.email}&code=${funcKey}`);

            if (response.ok) {
                userData = await response.json();
                console.log("Database match found. Coach:", userData.CoachName);
            }
        } catch (err) {
            console.log("Azure Fetch failed.");
        }

        document.getElementById('login-container').style.display = 'none';
        document.getElementById('bp-embedded-webchat').style.display = 'block';

        const logoutBtn = document.getElementById('logout-btn');
        logoutBtn.style.display = 'block';
        logoutBtn.onclick = () => {
            auth0Client.logout({
                logoutParams: { returnTo: "https://www.coachgit.com/index.html" }
            });
        };

        window.botpress.init({
            "botId": "ed2a1fe5-3f29-499c-a2ec-a22ef40d55f2",
            "clientId": "b4eb5d1b-c904-4b1f-aa25-864c8be55a0e",
            "configuration": {
                "version": "v2",
                "botName": (userData && userData.CoachName) ? userData.CoachName : "Coach Creator",
                "themeMode": "dark",
                "embeddedChatId": "bp-embedded-webchat",
                "showBotInfoPage": false
            }
        });

        window.botpress.on('webchat:initialized', () => {
            setTimeout(() => {
                window.botpress.updateUser({
                    data: {
                        "email": user.email,
                        "isNewUser": userData ? "false" : "true"
                    }
                });

                if (userData && userData.CoachName) {
                    window.botpress.configure({
                        "configuration": { "botName": userData.CoachName }
                    });
                }

                // Fixed: Using sendEvent for v3.5
                window.botpress.sendEvent({
                    type: 'text',
                    text: 'check_email'
                });
            }, 2000);
        });
    };

    window.onload = initializeAuth;
</script>
</body>

</html>

